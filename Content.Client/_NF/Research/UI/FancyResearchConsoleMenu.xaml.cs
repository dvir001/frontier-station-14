using System.Numerics;
using Content.Client.Parallax;
using Content.Client.Research;
using Content.Client.UserInterface.Controls;
using Content.Shared._NF.Research;
using Content.Shared.Access.Systems;
using Content.Shared.Research.Components;
using Content.Shared.Research.Prototypes;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.Player;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Input;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client._NF.Research.UI;

[GenerateTypedNameReferences]
public sealed partial class FancyResearchConsoleMenu : FancyWindow
{
    public Action<string>? OnTechnologyCardPressed;
    public Action? OnServerButtonPressed;

    [Dependency] private readonly IEntityManager _entity = default!;
    [Dependency] private readonly IPrototypeManager _prototype = default!;
    [Dependency] private readonly IPlayerManager _player = default!;

    private readonly ResearchSystem _research;
    private readonly SpriteSystem _sprite;
    private readonly AccessReaderSystem _accessReader;

    /// <summary>
    /// Console entity
    /// </summary>
    public EntityUid Entity;

    /// <summary>
    /// Currently selected tech
    /// Exists for better UI refreshing
    /// </summary>
    public ProtoId<TechnologyPrototype>? CurrentTech;

    /// <summary>
    /// All technologies and their availability
    /// </summary>
    public Dictionary<string, ResearchAvailability> List = new();

    /// <summary>
    /// Cached research points
    /// </summary>
    public int Points = 0;

    /// <summary>
    /// Is tech currently being dragged
    /// </summary>
    private bool _draggin;

    /// <summary>
    /// Tracks if first initialization has happened
    /// </summary>
    private bool _firstInitialization = true;

    /// <summary>
    /// the distance between elements on the grid.
    /// </summary>
    private const int GridSize = 90;

    /// <summary>
    /// technology cards size.
    /// </summary>
    private const int CardSize = 64;

    /// <summary>
    /// the distance between elements on the grid.
    /// </summary>
    private static readonly Vector2i DefaultPosition = Vector2i.Zero;

    private Box2i _bounds = new(DefaultPosition, DefaultPosition);

    private ParallaxControl _parallaxControl;

    private float _verticalScrollSpeed = 50;

    public FancyResearchConsoleMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        _research = _entity.System<ResearchSystem>();
        _sprite = _entity.System<SpriteSystem>();
        _accessReader = _entity.System<AccessReaderSystem>();

        // Initialize parallax background with dynamic sizing
        _parallaxControl = new ParallaxControl
        {
            ParallaxPrototype = "Default",
            HorizontalExpand = true,
            VerticalExpand = true,
            // Don't set fixed sizes - will be set dynamically based on tech tree bounds
        };

        // Add the parallax control to the DragContainer (now inside ScrollContainer)
        DragContainer.AddChild(_parallaxControl);

        // Set the proper rendering order by adjusting positions in the parent's child list
        // Controls with a higher position value are drawn on top (foreground)
        // Make sure the parallax is at the bottom of the z-order (drawn first)
        _parallaxControl.SetPositionInParent(0);

        // Set up scroll container properties - only vertical scrolling for tech tree
        TechScrollContainer.ScrollSpeedX = 100;
        TechScrollContainer.ScrollSpeedY = 100;
        TechScrollContainer.HScrollEnabled = false; // Disable horizontal scrolling
        TechScrollContainer.VScrollEnabled = true;  // Keep only vertical scrolling

        // Apply PDA-style scrollbar colors to match the style
        ApplyScrollbarStyling();

        ServerButton.OnPressed += _ => OnServerButtonPressed?.Invoke();
        DragContainer.OnKeyBindDown += OnKeybindDown;
        DragContainer.OnKeyBindUp += OnKeybindUp;
        RecenterButton.OnPressed += _ => Recenter();

        // Empty initialization
        UpdatePanels(List);
    }

    /// <summary>
    /// Apply scrollbar styling.
    /// </summary>
    private void ApplyScrollbarStyling()
    {
        var scrollBarNormal = new StyleBoxFlat
        {
            BackgroundColor = Color.FromHex("#80808059"),
            ContentMarginLeftOverride = 10,
            ContentMarginTopOverride = 10
        };

        var scrollBarHovered = new StyleBoxFlat
        {
            BackgroundColor = Color.FromHex("#8C8C8C59"),
            ContentMarginLeftOverride = 10,
            ContentMarginTopOverride = 10
        };

        var scrollBarGrabbed = new StyleBoxFlat
        {
            BackgroundColor = Color.FromHex("#8C8C8C59"),
            ContentMarginLeftOverride = 10,
            ContentMarginTopOverride = 10,
        };
    }

    public void SetEntity(EntityUid entity)
        => Entity = entity;

    public void UpdatePanels(Dictionary<string, ResearchAvailability> dict)
    {
        DragContainer.RemoveAllChildren();
        List = dict;
        var bounds = new Box2i();
        var boundsSet = false;

        // Re-add the parallax control first (it was removed with RemoveAllChildren)
        DragContainer.AddChild(_parallaxControl);
        _parallaxControl.SetPositionInParent(0);

        // generate bounding box, ensure position is within bounds
        foreach (var tech in List)
        {
            var proto = _prototype.Index<TechnologyPrototype>(tech.Key);
            // Fix Y coordinate so position (0,0) is at the top
            var position = DefaultPosition + (GridSize * proto.Position.X, GridSize * proto.Position.Y); // Normal Y: position (0,0) at top
            if (!boundsSet)
            {
                bounds.BottomLeft = position;
                bounds.TopRight = position;
                boundsSet = true;
            }
            else
            {
                bounds.Left = int.Min(position.X, bounds.Left);
                bounds.Bottom = int.Min(position.Y, bounds.Bottom);
                bounds.Right = int.Max(position.X, bounds.Right);
                bounds.Top = int.Max(position.Y, bounds.Top);
            }
        }

        if (boundsSet)
        {
            _bounds = bounds;

            // Calculate the total size needed for all techs with proper padding
            var padding = 200; // Increase padding to prevent edge clipping
            var totalWidth = _bounds.Width + CardSize + padding;
            var totalHeight = _bounds.Height + CardSize + padding;

            // Set the DragContainer to be large enough to contain all technologies
            DragContainer.SetWidth = Math.Max(totalWidth, 1000);
            DragContainer.SetHeight = Math.Max(totalHeight, 1000);

            // Update parallax size to match the tech tree bounds
            _parallaxControl.SetWidth = DragContainer.SetWidth;
            _parallaxControl.SetHeight = DragContainer.SetHeight;
            // Position parallax to cover the entire tech area
            LayoutContainer.SetPosition(_parallaxControl, new Vector2(0, 0));

            // First-time initialization
            if (_firstInitialization)
            {
                _firstInitialization = false;
            }
        }

        foreach (var tech in List)
        {
            var proto = _prototype.Index<TechnologyPrototype>(tech.Key);

            var control = new FancyResearchConsoleItem(proto, _sprite, tech.Value);
            DragContainer.AddChild(control);

            // Set position for all tech with better centering to prevent right edge overflow
            var leftPadding = 100; // Add left padding to move tree away from left edge
            var topPadding = 100;  // Add top padding to move tree away from top edge
            var uiPosition = new Vector2(
                proto.Position.X * GridSize - _bounds.Left + leftPadding, // Offset from bounds left + padding
                proto.Position.Y * GridSize - _bounds.Bottom + topPadding // Offset from bounds bottom + padding (normal Y)
            );
            LayoutContainer.SetPosition(control, uiPosition);
            control.SelectAction += SelectTech;

            // Set selection state based on CurrentTech
            control.IsSelected = tech.Key == CurrentTech;
        }
    }

    public void UpdateInformationPanel(int points)
    {
        Points = points;

        var amountMsg = new FormattedMessage();
        amountMsg.AddMarkupOrThrow(Loc.GetString("research-console-menu-research-points-text",
            ("points", points)));
        ResearchAmountLabel.SetMessage(amountMsg);

        if (!_entity.TryGetComponent(Entity, out TechnologyDatabaseComponent? database))
            return;

        TierDisplayContainer.RemoveAllChildren();
        foreach (var disciplineId in database.SupportedDisciplines)
        {
            var discipline = _prototype.Index<TechDisciplinePrototype>(disciplineId);
            var tier = _research.GetTierCompletionPercentage(database, discipline, _prototype);

            // i'm building the small-ass control here to spare me some mild annoyance in making a new file
            var texture = new TextureRect
            {
                TextureScale = new Vector2(2, 2),
                VerticalAlignment = VAlignment.Center
            };
            var label = new RichTextLabel();
            texture.Texture = _sprite.Frame0(discipline.Icon);
            label.SetMessage(Loc.GetString("research-console-tier-percentage", ("perc", tier)));

            var control = new BoxContainer
            {
                Children =
                {
                    texture,
                    label,
                    new Control
                    {
                        MinWidth = 10
                    }
                }
            };
            TierDisplayContainer.AddChild(control);
        }
    }

    #region Drag handle
    protected override void MouseMove(GUIMouseMoveEventArgs args)
    {
        base.MouseMove(args);

        if (!_draggin)
            return;

        // Directly adjust scroll position instead of moving individual tech items
        var scrollSpeed = 2.0f; // Adjust sensitivity
        TechScrollContainer.VScrollTarget -= args.Relative.Y * scrollSpeed;

        // The scroll container will automatically clamp the values
    }

    /// <summary>
    /// Raised when LMB is pressed at <see cref="DragContainer"/>
    /// </summary>
    private void OnKeybindDown(GUIBoundKeyEventArgs args)
    {
        if (args.Function == EngineKeyFunctions.Use)
            _draggin = true;
    }

    /// <summary>
    /// Raised when LMB is unpressed at <see cref="DragContainer"/>
    /// </summary>
    private void OnKeybindUp(GUIBoundKeyEventArgs args)
    {
        if (args.Function == EngineKeyFunctions.Use)
            _draggin = false;
    }

    protected override DragMode GetDragModeFor(Vector2 relativeMousePos)
        => _draggin ? DragMode.None : base.GetDragModeFor(relativeMousePos);
    #endregion

    /// <summary>
    /// Selects a tech prototype and opens info panel
    /// </summary>
    /// <param name="proto">Tech proto</param>
    /// <param name="availability">Tech availability</param>
    public void SelectTech(TechnologyPrototype proto, ResearchAvailability availability)
    {
        InfoContainer.RemoveAllChildren();
        if (!_player.LocalEntity.HasValue)
            return;

        // Update current tech selection
        var previousTech = CurrentTech;
        CurrentTech = proto.ID;

        // Update selection state for all tech items
        foreach (var child in DragContainer.Children)
        {
            if (child is FancyResearchConsoleItem techItem)
            {
                techItem.IsSelected = techItem.Prototype.ID == CurrentTech;
            }
        }

        var control = new FancyTechnologyInfoPanel(proto, _accessReader.IsAllowed(_player.LocalEntity.Value, Entity), availability, _sprite);
        control.BuyAction += args => OnTechnologyCardPressed?.Invoke(args.ID);
        InfoContainer.AddChild(control);
    }

    /// <summary>
    /// Resets the view exactly to the initial position when the UI was first opened
    /// </summary>
    public void Recenter()
    {
        // Reset scroll container to top position (since we're using vertical-only scrolling)
        TechScrollContainer.VScrollTarget = 0;

        // No need to manually reposition tech items since they're now positioned absolutely
        // within the properly-sized DragContainer
    }

    public override void Close()
    {
        base.Close();

        DragContainer.RemoveAllChildren();
        InfoContainer.RemoveAllChildren();
        _firstInitialization = true;
    }

    private sealed partial class DisciplineButton(TechDisciplinePrototype proto) : Button
    {
        public TechDisciplinePrototype Proto = proto;
    }

    protected override void MouseWheel(GUIMouseWheelEventArgs args)
    {
        // Let the scroll container handle mouse wheel naturally
        base.MouseWheel(args);
    }
}
